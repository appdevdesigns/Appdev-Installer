<!DOCTYPE html>
<html>
	<head>
    	<title>Appdev Installer</title>
			<link rel="stylesheet" href="modules/webix/webix.css" type="text/css">
			<link rel="stylesheet" href="css/appdev-installer.css" type="text/css"> 
			<script src="modules/webix/webix.js" type="text/javascript"></script>
			<script src="js/jquery-3.1.0.min.js" type="text/javascript"></script>
			<script type="text/javascript">
				var rootPassword = "";
				var language_selected = ""
				var application_name = "";
				$(function(){
					hide_all_component();
					update_page(1);
				});
				function update_page(itemid) {
					var id = parseInt(itemid);
					hide_all_component();
			        $$('side-menu').select(id);
					switch (id) {
						case 1:
							$("#appdevgui-language-component").show();
							break;
						case 2:
							$("#appdevgui-profile-component").show();
							break;
						case 3:
							$("#appdevgui-verifyreq-component").show();
							break;
						case 4:
							$("#appdevgui-dbconfig-component").show();
							break;
						case 5:
							$("#appdevgui-siteconfig-component").show();
							break;
						case 6:
							$("#appdevgui-installer-component").show();
							$$('installer-input').focus();
							break;
						default:
							console.error("Bad component index");
							// statements_def
							break;
					}
				}

				function hide_all_component() {
					$('.component').hide();
				}

				function node_version () {
					console.log('Check Node version');
					const node_version_exec = require('child_process').exec;
					node_version_exec('/usr/local/bin/node -v', (error, stdout, stderr) => {
					  if (error) {
					    console.warn("Node Version Error");
			            $$('installer-log').setValue("Node Version Error\n");
			            // brew_install();
					    return;
					  }
			          $$('installer-log').setValue("Current Node Version: " + `${stdout}`);
			          sails_version();
					});
				}

				function brew_install() {
					const brew_command_exec = require('child_process').exec;
			            $$('installer-log').setValue($$('installer-log').getValue() + "Installing Brew! Please wait");
					brew_command_exec('/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"', (error, stdout, stderr) => {
					  if (error) {
			            $$('installer-log').setValue($$('installer-log').getValue() + "Error: " + `${error}`);
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "New installing Brew latest version...");
					  // $$('installer-log').setValue($$('installer-log').getValue() + "Output: " + `${stdout}`);
					  node_install();
					});
				}

				function node_install() {
					const node_install = require('child_process').exec;
					node_install_exec('brew install node', (error, stdout, stderr) => {
					  if (error) {
			            $$('installer-log').setValue($$('installer-log').getValue() + "Error: " + `${error}`);
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "New installing Node latest version...");
					  // $$('installer-log').setValue($$('installer-log').getValue() + "Output: " + `${stdout}`);
					  sails_version();
					});
				}

				function sails_version () {
					console.log('Check Sails version');
					const sails_version_exec = require('child_process').exec;
					sails_version_exec('echo ' + rootPassword + ' | sudo -S /usr/local/bin/node /usr/local/bin/sails -v', (error, stdout, stderr) => {
					  if (error) {
					    console.warn("This machine doesn't have Sails");
			            $$('installer-log').setValue($$('installer-log').getValue() + "This machine doesn't have Sails\n");
					    $$('installer-log').setValue($$('installer-log').getValue() + "New installing Sails latest version...");
			            install_sails();
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "Current Sails Version: " + `${stdout}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "Update Sails to latest version...");
			          install_sails();
					});
				}

				function install_sails () {
					console.log('Install Sails');
					webix.message("Installing Sails");
					const install_sails_exec = require('child_process').exec;
					install_sails_exec('echo ' + rootPassword + ' | sudo -S /usr/local/bin/node /usr/local/bin/npm install sails -g', (error, stdout, stderr) => {
					  if (error) {
					    console.error(`exec error: ${error}`);
					  	$$('installer-log').setValue($$('installer-log').getValue() + "\nPlease check error log:\n" +`${error}`);
					    return;
					  }
					  //console.log(`stdout: ${stdout}`);
					  //console.log(`stderr: ${stderr}`);
					  // $$('installer-log').setValue($$('installer-log').getValue() + `${stdout}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "\nInstalled Sails Successful");
					  appdevdesigns_version();
					});
				}

				function appdevdesigns_version () {
					console.log('Check Appdev-designs version');
					const appdevdesigns_version_exec = require('child_process').exec;
					appdevdesigns_version_exec('/usr/local/bin/node /usr/local/bin/appdev -V', (error, stdout, stderr) => {
					  if (error) {
					    console.warn("This machine doesn't have Appdev-designs");
			            $$('installer-log').setValue($$('installer-log').getValue() + "This machine doesn't have Appdev-designs\n");
					    $$('installer-log').setValue($$('installer-log').getValue() + "\nNew installing Appdev-designs latest version...");
			            install_appdevdesigns();
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
			          $$('installer-log').setValue($$('installer-log').getValue() + "\nCurrent Appdev-designs Version: " + `${stdout}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "Update Appdev-designs to latest version...");
			          install_appdevdesigns();
					});
				}

				function install_appdevdesigns () {
					console.log('install Appdev-designs');
					webix.message("Installing Appdev-designs");
					const install_appdevdesigns_exec = require('child_process').exec;
					install_appdevdesigns_exec('echo ' + rootPassword + ' | sudo -S /usr/local/bin/node /usr/local/bin/npm install appdevdesigns/appdev-cli -g', (error, stdout, stderr) => {
					  if (error) {
					    console.error(`exec error: ${error}`);
					  	$$('installer-log').setValue($$('installer-log').getValue() + "\nPlease check error log:\n" +`${error}`);
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  // $$('installer-log').setValue($$('installer-log').getValue() + `${stdout}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "\nInstalled Appdev-design Successful");
					  webix.message("Installing appdev-design complete");
					});
				}

			</script>
  	</head>
  	<body>
  		<div id="appdevgui-home-component">
			<h1 class="page-header text-center">
				<br>Appdev GUI Cross-platform
			</h1>
			<div id="appdevgui-side-component">
		        <div id="appdevgui-side">
			      <script type="text/javascript" charset="utf-8">
			        webix.ui({
			          view:"list",
			          id:"side-menu",
			          width:200,
			          height:204,
			          container:"appdevgui-side",
			          template:"#title#",
			          select:true,
			          navigation: true,
			          css:"side-menu-list",
			          data:[
			            { "id":1, "title":"Choose Language", "page":"#" },
			            { "id":2, "title":"Choose Profile", "page":"#"  },
			            { "id":3, "title":"Verify Requirements", "page":"#"  },
			            { "id":4, "title":"Configure Database", "page":"#"  },
			            { "id":5, "title":"Configure Site", "page":"#"  },
			            { "id":6, "title":"Finish", "page":"#"  }
			          ]
			        });
			        $$('side-menu').attachEvent("onItemClick", function(id, e, node){
			            var item = this.getItem(id);
			            // webix.message(id);
			            update_page(id);
			        });
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-language-component" class="component hidden">
		    	<div id="appdevgui-language">
			      <div class="language-label">
			        Choose language
			      </div>
			      <script type="text/javascript" charset="utf-8">
			        webix.ui({
			          view:"combo",
			          id:"language-combo",
			          container:"appdevgui-language",
			          value:1, //the initially selected one
			          width: 300,
			          options:[ 
			              { id:1, value:"English"}, 
			              { id:2, value:"English" }, 
			              { id:3, value:"English" }
			          ]
			        });
			        webix.ui({
			          view:"button",
			          css:"language-next",
			          container:"appdevgui-language",
			          width: 300,
			          type: "next",
			          label: "Next",
			          on:{
			            "onItemClick": function(id, e, trg) {
			              language_selected = $$('language-combo').getValue();
			              update_page(2);
			            }
			          }
			        });
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-profile-component" class="component hidden">
		    	<div id="appdevgui-profile">
			      <script type="text/javascript" charset="utf-8">
			      webix.ui({
			      		view:"form",
			      		css:"view-form",
			      		container: "appdevgui-profile",
			      		id:"profile-form",
			      		elements:[{
						      		view: "text", 
						      		height: 60,
						      		width: 300,
						      		id: "profile-input",
						      		name: "profile-input",
						      		labelPosition: "top",
						      		label: "Application name",
						      		require:true
						      	  },
						      	  {
							        view:"button",
							        css:"next-btn",
							        container:"appdevgui-profile",
							        width: 300,
							        type: "next",
							        label: "Next",
							        on:{
							          "onItemClick": function(id, e, trg) {
							          	application_name = $$('profile-input').getValue();
							            update_page(3);
							          }
							        }
							      }
				      			],
				      	rules: {
				      		"installer-input":webix.rules.isNotEmpty
				      	}
			      	});
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-verifyreq-component" class="component hidden">
		    	<div id="appdevgui-verifyreq">
			      <script type="text/javascript" charset="utf-8">
			        webix.ui({
			          view:"button",
			          css:".next-btn",
			          container:"appdevgui-verifyreq",
			          width: 300,
			          type: "next",
			          label: "Next",
			          on:{
			            "onItemClick": function(id, e, trg) {
			              update_page(4);
			            }
			          }
			        });
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-dbconfig-component" class="component hidden">
		    	<div id="appdevgui-dbconfig">
			      <script type="text/javascript" charset="utf-8">
			        webix.ui({
			          view:"button",
			          css:".next-btn",
			          container:"appdevgui-dbconfig",
			          width: 300,
			          type: "next",
			          label: "Next",
			          on:{
			            "onItemClick": function(id, e, trg) {
			              update_page(5);
			            }
			          }
			        });
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-siteconfig-component" class="component hidden">
		    	<div id="appdevgui-siteconfig">			      
		    	<script type="text/javascript" charset="utf-8">
			        webix.ui({
			          view:"button",
			          css:".next-btn",
			          container:"appdevgui-siteconfig",
			          width: 300,
			          type: "next",
			          label: "Next",
			          on:{
			            "onItemClick": function(id, e, trg) {
			              update_page(6);
			            }
			          }
			        });
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-installer-component" class="component hidden">
			    <div id="appdevgui-installer">
			      <script type="text/javascript" charset="utf-8">
			      	webix.ui({
			      		view: "textarea", 
			          	container: "appdevgui-installer",
			      		height: 230,
			      		labelPosition: "top",
			      		hidden: true,
			      		id: "installer-log"
			      	});
			      	webix.ui({
			      		view:"form",
			      		css:"view-form",
			      		container: "appdevgui-installer",
			      		id:"installer-form",
			      		elements:[{
						      		view: "text", 
						      		height: 60,
						      		width: 300,
						      		id: "installer-input",
						      		name: "installer-input",
						      		labelPosition: "top",
						      		label: "Root password",
						      		require:true
						      	  },
						      	  {
							        view:"button",
							        width: 200,
							        label: "Install",
							        id: "installer-button",
							        on:{
							          "onItemClick": function(id, e, trg) {
							          	var form = this.getParentView();
										if (form.validate()) {
											webix.message("Installing Component");
											rootPassword = $$('installer-input').getValue();
									        $$('installer-form').hide();
									    	$$('installer-log').show();
							            	$$('installer-log').disable();
							            	setTimeout(function() {
								            	node_version();
								            	// sails_version();
								            	// test_command();
							            	}, 1000);
							            } else { 
											webix.message({ type:"error", text:"Root password must not empty" });
										}
							          }
							        }
							      }
				      			 ],
				      	rules: {
				      		"installer-input":webix.rules.isNotEmpty
				      	}
			      	});
			      </script>
			    </div>
		    </div>
    		<div class="clear"></div>
		</div>
  	</body>
</html>