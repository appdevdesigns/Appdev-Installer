<!DOCTYPE html>
<html>
	<head>
    	<title>Appdev Installer</title>
			<link rel="stylesheet" href="modules/webix/webix.css" type="text/css">
			<link rel="stylesheet" href="css/appdev-installer.css" type="text/css"> 
			<script src="modules/webix/webix.js" type="text/javascript"></script>
			<script src="js/jquery-3.1.0.min.js" type="text/javascript"></script>
			<script type="text/javascript">
				//GLOBAL
				var language_selected = "";

				var profile_install = "";
				var mysql_optional = "";
				var directory_profile = "";
				var application_name = "";
				var folder_name = "";

				var node_symlink = "";
				var local_bin = "";
				var needGit = false;
				var needNode = false;
				var needSails = false;
				var needAppdev = false;

				var database_name = "";
				var database_root = "";
				var database_password = "";
				var database_port = "";
				var database_host = "";

				var rootPassword = "";

				$(function(){
					hide_all_component();
					update_page(1);
				});
				function update_page(itemid) {
					var id = parseInt(itemid);
					hide_all_component();
			        $$('side-menu').select(id);
					switch (id) {
						case 1:
							$("#appdevgui-language-component").show();
							break;
						case 2:
							$("#appdevgui-profile-component").show();
							break;
						case 3:
							$("#appdevgui-verifyreq-component").show();
							// webix.message("Verify Requirements");
			          		$$('verifyreq-next').disable();
			          		$$('verifyreq-back').disable();
			          		$$('req-node').setValue("");
			          		$$('req-git').setValue("");
			          		$$('req-sails').setValue("");
			          		$$('req-appdev').setValue("");
			          		which_node();
							break;
						case 4:
							$("#appdevgui-dbconfig-component").show();
							break;
						case 5:
							$("#appdevgui-siteconfig-component").show();
							break;
						case 6:
							$("#appdevgui-installer-component").show();
							$$('installer-input').focus();
							break;
						default:
							console.error("Bad component index");
							// statements_def
							break;
					}
				}

				function hide_all_component() {
					$('.component').hide();
				}

				function test_command () {
					console.log('Test Command');
					const test_command_exec = require('child_process').exec;
					test_command_exec('which node', (error, stdout, stderr) => {
					  if (error) {
			            $$('debug-log').setValue(`${stderr}`);
					    return;
					  }
			          $$('debug-log').setValue(`${stdout}`);
					});
				}

				function which_node () {
					console.log('Which Node');
					const which_node_exec = require('child_process').exec;
					which_node_exec('which node', (error, stdout, stderr) => {
					  if (error) {
					    console.warn("Node Version Error");
			            $$('req-node').setValue("No Node installed");
			            console.log(`${stderr}`);
			            node_version();
					    return;
					  }
			          console.log(`${stdout}`);
			          //Remove Newline
			          node_symlink = stdout.replace(/(\r\n|\n|\r)/gm,"");
			          local_bin = node_symlink.replace("node", "");
					  console.log(node_symlink);
					  console.log(local_bin);
			          node_version();
					});
				}

				function node_version () {
					console.log('Check Node version');
					const node_version_exec = require('child_process').exec;
					node_version_exec(node_symlink + ' -v', (error, stdout, stderr) => {
					  if (error) {
			            // brew_install();
			            $$('req-node').setValue("Node version error");
			            needNode = true;
			            git_version();
					    return;
					  }
			          $$('req-node').setValue(`${stdout}`);
			          needNode = false;
			          git_version();
					});
				}

				function open_node_package() {
					console.log('Open Node package');
					var fs = require('fs')
					var path = require('path')
					var fd = fs.openSync(path.join(process.cwd(), 'packages/node-v6.7.0.pkg'), 'rs')
					fs.writeSync(fd, 'contents to append')
					setTimeout(function () {
					  console.log('closing file now')
					  fs.closeSync(fd)
					}, 10000)
				}
				// function brew_install() {
				// 	const brew_command_exec = require('child_process').exec;
			 //            $$('installer-log').setValue($$('installer-log').getValue() + "Installing Brew! Please wait");
				// 	brew_command_exec('/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"', (error, stdout, stderr) => {
				// 	  if (error) {
			 //            $$('installer-log').setValue($$('installer-log').getValue() + "Error: " + `${error}`);
				// 	    return;
				// 	  }
				// 	  // console.log(`stdout: ${stdout}`);
				// 	  // console.log(`stderr: ${stderr}`);
				// 	  $$('installer-log').setValue($$('installer-log').getValue() + "New installing Brew latest version...");
				// 	  // $$('installer-log').setValue($$('installer-log').getValue() + "Output: " + `${stdout}`);
				// 	  node_install();
				// 	});
				// }

				// function node_install() {
				// 	const node_install = require('child_process').exec;
				// 	node_install_exec('brew install node', (error, stdout, stderr) => {
				// 	  if (error) {
			 //            $$('installer-log').setValue($$('installer-log').getValue() + "Error: " + `${error}`);
				// 	    return;
				// 	  }
				// 	  // console.log(`stdout: ${stdout}`);
				// 	  // console.log(`stderr: ${stderr}`);
				// 	  $$('installer-log').setValue($$('installer-log').getValue() + "New installing Node latest version...");
				// 	  // $$('installer-log').setValue($$('installer-log').getValue() + "Output: " + `${stdout}`);
				// 	  sails_version();
				// 	});
				// }

				function git_version () {
					console.log('Check Git version');
					const git_version_exec = require('child_process').exec;
					git_version_exec('git --version', (error, stdout, stderr) => {
					  if (error) {
					    console.warn("This machine doesn't have Git");
			            $$('req-git').setValue("No Git installed");
					    // $$('installer-log').setValue($$('installer-log').getValue() + "New installing Sails latest version...");
			            //install_sails();
			          	needGit = true;
			          	sails_version();
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  $$('req-git').setValue(`${stdout}`);
					  // $$('req-sails').setValue($$('installer-log').getValue() + "Update Sails to latest version...");
			          //install_sails();
			          needGit = true;
			          sails_version();
					});
				}


				function sails_version () {
					console.log('Check Sails version');
					const sails_version_exec = require('child_process').exec;
					sails_version_exec(node_symlink + " " + local_bin + "sails -v", (error, stdout, stderr) => {
					  if (error) {
					    console.warn("This machine doesn't have Sails");
			            $$('req-sails').setValue("No SailsJS installed");
					    // $$('installer-log').setValue($$('installer-log').getValue() + "New installing Sails latest version...");
			            //install_sails();
			          	needSails = true;
			          	appdevdesigns_version();
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  $$('req-sails').setValue(`${stdout}`);
					  // $$('req-sails').setValue($$('installer-log').getValue() + "Update Sails to latest version...");
			          //install_sails();
			          needSails = true;
			          appdevdesigns_version();
					});
				}

				function install_sails () {
					console.log('Install Sails');
					webix.message("Installing Sails");
					$$('installer-log').setValue($$('installer-log').getValue() + "Installing Sails...");
					const install_sails_exec = require('child_process').exec;
					var cmd = 'echo ' + rootPassword + ' | sudo -S ' + node_symlink + ' ' + local_bin +'npm install sails -g';
					console.log(cmd);
					install_sails_exec(cmd, (error, stdout, stderr) => {
					  if (error) {
					    console.error(`exec error: ${error}`);
					  	$$('installer-log').setValue($$('installer-log').getValue() + "\nPlease check error log:\n" +`${error}`);
					  	// install_appdevdesigns();
					    return;
					  }
					  console.log(`stdout: ${stdout}`);
					  //console.log(`stderr: ${stderr}`);
					  // $$('installer-log').setValue($$('installer-log').getValue() + `${stdout}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "\nInstalled Sails Successful");
					  install_appdevdesigns();
					});
				}

				function appdevdesigns_version () {
					console.log('Check Appdev-designs version');
					const appdevdesigns_version_exec = require('child_process').exec;
					appdevdesigns_version_exec(node_symlink + " " + local_bin + "appdev -V", (error, stdout, stderr) => {
					  if (error) {
					    console.warn("This machine doesn't have Appdev-designs");
			            $$('req-appdev').setValue("No Appdev-designs installed");
					    // $$('installer-log').setValue($$('installer-log').getValue() + "\nNew installing Appdev-designs latest version...");
			            // install_appdevdesigns();
			            needAppdev = true;
			            $$('verifyreq-back').enable();
			            $$('verifyreq-next').enable();
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
			          $$('req-appdev').setValue(`${stdout}`);
			            needAppdev = true;
					  // $$('installer-log').setValue($$('installer-log').getValue() + "Update Appdev-designs to latest version...");
			          // install_appdevdesigns();
			          $$('verifyreq-next').enable();
			          $$('verifyreq-back').enable();
					});
				}

				function install_appdevdesigns () {
					console.log('install Appdev-designs');
					webix.message("Installing Appdev-designs");
					$$('installer-log').setValue($$('installer-log').getValue() + "\nInstalling Appdev-design...");
					const install_appdevdesigns_exec = require('child_process').exec;
					install_appdevdesigns_exec('echo ' + rootPassword + ' | sudo -S ' + node_symlink + ' ' + local_bin + 'npm install appdevdesigns/appdev-cli -g', (error, stdout, stderr) => {
					  if (error) {
					    console.error(`exec error: ${error}`);
					  	$$('installer-log').setValue($$('installer-log').getValue() + "\nPlease check error log:\n" +`${error}`);
					    return;
					  }
					  console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  // $$('installer-log').setValue($$('installer-log').getValue() + `${stdout}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "\nInstalled Appdev-design Successful");
					  create_appdev();
					});
				}

				function create_appdev() {
					console.log('Create Appdev-designs app');
					$$('installer-log').setValue($$('installer-log').getValue() + "\nCreating Appdev-design app...");
					const create_appdev_exec = require('child_process').exec;
					create_appdev_exec(node_symlink + ' ' + local_bin + 'appdev install sails ', (error, stdout, stderr) => {
					  if (error) {
					    console.error(`exec error: ${error}`);
					  	$$('installer-log').setValue($$('installer-log').getValue() + "\nPlease check error log:\n" +`${error}`);
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  // $$('installer-log').setValue($$('installer-log').getValue() + `${stdout}`);
					  $$('installer-log').setValue($$('installer-log').getValue() + "\nCreated Appdev-design app");
					  sails_lift();
					});
				}

				function sails_lift() {
					console.log('Sails Lift');
					$$('installer-log').setValue($$('installer-log').getValue() + "\nSails Lift");
					const sails_lift_exec = require('child_process').exec;
					sails_lift_exec('cd sails && sails lift', (error, stdout, stderr) => {
					  if (error) {
					    console.error(`exec error: ${error}`);
					  	$$('installer-log').setValue($$('installer-log').getValue() + "\nPlease check error log:\n" +`${error}`);
					    return;
					  }
					  // console.log(`stdout: ${stdout}`);
					  // console.log(`stderr: ${stderr}`);
					  // $$('installer-log').setValue($$('installer-log').getValue() + `${stdout}`);
					});
				}
			</script>
  	</head>
  	<body>
  		<div id="appdevgui-home-component">
			<h1 class="page-header text-center">
				<br>Appdev GUI Cross-platform
			</h1>
			<script type="text/javascript" charset="utf-8">
		    		webix.ui({
			      		view: "textarea",
			      		height: 400,
			      		width: 600,
			      		id: "debug-log",
			      		hidden: true
			      	});
			</script>
			<div id="appdevgui-side-component">
		        <div id="appdevgui-side">
			      <script type="text/javascript" charset="utf-8">
			        webix.ui({
			          view:"list",
			          id:"side-menu",
			          width:200,
			          height:166,
			          container:"appdevgui-side",
			          template:"#title#",
			          select:true,
			          navigation:true,
			          disabled:true,
			          css:"side-menu-list",
			          data:[
			            { "id":1, "title":"Choose Language", "page":"#" },
			            { "id":2, "title":"Choose Profile", "page":"#"  },
			            { "id":3, "title":"Verify Requirements", "page":"#"  },
			            { "id":4, "title":"Configure Database", "page":"#"  },
			            // { "id":5, "title":"Configure Site", "page":"#"  },
			            { "id":6, "title":"Finish", "page":"#"  }
			          ]
			        });
			        $$('side-menu').attachEvent("onItemClick", function(id, e, node){
			            var item = this.getItem(id);
			            // webix.message(id);
			            update_page(id);
			        });
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-language-component" class="component hidden">
		    	<div id="appdevgui-language">
			      <div class="language-label">
			        Choose language
			      </div>
			      <script type="text/javascript" charset="utf-8">
			        webix.ui({
			          view:"combo",
			          id:"language-combo",
			          container:"appdevgui-language",
			          value:1, //the initially selected one
			          width: 300,
			          options:[ 
			              { id:1, value:"English"}, 
			              { id:2, value:"English" }, 
			              { id:3, value:"English" }
			          ]
			        });
			        webix.ui({
			          view:"button",
			          css:"next-btn",
			          container:"appdevgui-language",
			          width: 200,
			          type: "next",
			          label: "Next",
			          on:{
			           	"onItemClick": function(id, e, trg) {
			              language_selected = $$('language-combo').getValue();
			              update_page(2);
			            }
			          }
			        });
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-profile-component" class="component hidden">
		    	<div id="appdevgui-profile">
			      <script type="text/javascript" charset="utf-8">
			      webix.ui({
			      		view:"form",
			      		css:"view-form",
			      		container: "appdevgui-profile",
			      		id:"profile-form",
			      		elements:[{ 
			      					view: "radio", 
			      					name: "profile-radio",
			      					id: "profile-radio",
			      					label: "Choose Profile", 
			      					value: 1,
			      					height: 60,
			      					css: "profile-radio", 
			      					labelWidth: 150, 
			      					options: [
									  	{ value:"Default Install", id:1 },
									  	{ value:"Custom Install", id:2 }],
									on: {
									  	"onItemClick": function(id, e, trg) {
									  	var temp = $$('profile-radio').getValue();
									  	switch (temp) {
									  		case "1":
									  			$$('profile-checkbox').hide();
									  			$$('profile-checkbox').setValue(0);
									  			$$('profile-input').disable();
									  			$$('profile-input').setValue("/sails/");
									  			break;
									  		case "2":
									  			$$('profile-checkbox').show();
									  			$$('profile-input').enable();
									  			$$('profile-input').focus();
									  			break;
									  		default:
									  			// statements_def
									  			break;
									  	}
									  }
									}
								  },
			      				  {
			      				  	view: "checkbox", 
								    id: "profile-checkbox", 
								    label: "MySql [Optional]", 
			      					labelWidth: 150, 
								    value: 0,
								    hidden: true
			      				  },
			      				  {
						      		view: "text", 
						      		height: 60,
						      		width: 300,
						      		id: "profile-input",
						      		name: "profile-input",
						      		labelPosition: "top",
								    disabled: true,
								    value: "/sails/",
						      		label: "Appdev Directory"//,
						      		// require:true
						      	  }
				      			],
				      	rules: {
				      		"installer-input":webix.rules.isNotEmpty
				      	}
			      	});
					webix.ui({
						view:"button",
			          	css:"next-btn",
			        	container:"appdevgui-profile",
			       		width: 200,
			       		type: "next",
			       		label: "Next",
			       		on:{
							"onItemClick": function(id, e, trg) {
							  	directory_profile = $$('profile-input').getValue();
				           	  	profile_install = $$('profile-radio').getValue();
							  	mysql_optional = $$('profile-checkbox').getValue();
							  	// webix.message("Directory : " + directory_profile);
							  	// webix.message("Profile : "+ profile_install);
							  	// webix.message("Mysql : " + mysql_optional);
							  	update_page(3);
				        	}
		      			}
			        });
			        webix.ui({
			        	view:"button",
						css:"back-btn",
						container:"appdevgui-profile",
						width: 200,
						type: "prev",
						label: "Back",
						on:{
							"onItemClick": function(id, e, trg) {
							  	update_page(1);
							}
						}
					});
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-verifyreq-component" class="component hidden">
		    	<div id="appdevgui-verifyreq">
			      <script type="text/javascript" charset="utf-8">
			      	webix.ui({
			        	view: "text", 
						height: 40,
				      	width: 320,
				 		id: "req-node",
			    		name: "req-node",
				 		labelPosition: "left",
						disabled: true,
						label: "NodeJS :",
			        	container:"appdevgui-verifyreq",
			      		labelWidth: 80,
			      		css: "verifyreq-input"
					});
					webix.ui({
			        	view: "text", 
						height: 40,
				      	width: 320,
				 		id: "req-git",
			    		name: "req-git",
				 		labelPosition: "left",
						disabled: true,
						label: "Git :",
			        	container:"appdevgui-verifyreq",
			      		labelWidth: 80, 
			      		css: "verifyreq-input"
					});
					webix.ui({
			        	view: "text", 
						height: 40,
				      	width: 320,
				 		id: "req-sails",
			    		name: "req-sails",
				 		labelPosition: "left",
						disabled: true,
						label: "SailsJS :",
			        	container:"appdevgui-verifyreq",
			      		labelWidth: 80, 
			      		css: "verifyreq-input"
					});
					webix.ui({
			        	view: "text", 
						height: 40,
				      	width: 320,
				 		id: "req-appdev",
			    		name: "req-appdev",
				 		labelPosition: "left",
						disabled: true,
						label: "Appdev-Designs :",
			        	container:"appdevgui-verifyreq",
			      		labelWidth: 130, 
			      		css: "verifyreq-input"
					});
			        webix.ui({
						view:"button",
			          	css:"next-btn",
			        	container:"appdevgui-verifyreq",
			       		width: 200,
			       		type: "next",
			       		label: "Next",
			       		disabled: true,
			       		id:"verifyreq-next",
			       		on:{
							"onItemClick": function(id, e, trg) {
					          update_page(4);
				        	}
		      			}
			        });
			        webix.ui({
			        	view:"button",
						css:"back-btn",
						container:"appdevgui-verifyreq",
						width: 200,
						type: "prev",
						label: "Back",
			       		disabled: true,
			       		id:"verifyreq-back",
						on:{
							"onItemClick": function(id, e, trg) {
							  update_page(2);
							}
						}
					});
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-dbconfig-component" class="component hidden">
		    	<div id="appdevgui-dbconfig">
			      <script type="text/javascript" charset="utf-8">
			      	webix.ui({
			      		view: "textarea", 
			          	container: "appdevgui-dbconfig",
			      		height: 200,
			      		width: 300,
			      		labelPosition: "top",
			      		label: "Database",
			      		id: "dbinstaller-log"
			      	});
			        webix.ui({
			          view:"button",
			          css:"next-btn",
			          container:"appdevgui-dbconfig",
			          width: 200,
			          type: "next",
			          label: "Next",
			          on:{
			            "onItemClick": function(id, e, trg) {
			              update_page(6);
			            }
			          }
			        });
			        webix.ui({
			        	view:"button",
						css:"back-btn",
						container:"appdevgui-dbconfig",
						width: 200,
						type: "prev",
						label: "Back",
						on:{
							"onItemClick": function(id, e, trg) {
							  update_page(3);
							}
						}
					});
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-siteconfig-component" class="component hidden">
		    	<div id="appdevgui-siteconfig">			      
		    	<script type="text/javascript" charset="utf-8">
			        webix.ui({
			          view:"button",
			          css:"next-btn",
			          container:"appdevgui-siteconfig",
			          width: 200,
			          type: "next",
			          label: "Next",
			          on:{
			            "onItemClick": function(id, e, trg) {
			              update_page(6);
			            }
			          }
			        });
			      </script>
			    </div>
		    </div>
		    <div id="appdevgui-installer-component" class="component hidden">
			    <div id="appdevgui-installer">
			      <script type="text/javascript" charset="utf-8">
			      	webix.ui({
			      		view: "textarea", 
			          	container: "appdevgui-installer",
			      		height: 230,
			      		labelPosition: "top",
			      		hidden: true,
			      		id: "installer-log"
			      	});
			      	webix.ui({
			      		view:"form",
			      		css:"view-form",
			      		container: "appdevgui-installer",
			      		id:"installer-form",
			      		elements:[{
						      		view: "text",
						      		type: "password",
						      		height: 60,
						      		width: 300,
						      		id: "installer-input",
						      		name: "installer-input",
						      		labelPosition: "top",
						      		label: "Root password",
						      		require:true
						      	  },
						      	  {
							        view:"button",
							        width: 200,
							        label: "Install",
							        id: "installer-button",
							        on:{
							          "onItemClick": function(id, e, trg) {
							          	var form = this.getParentView();
										if (form.validate()) {
											webix.message("Installing Component");
											rootPassword = $$('installer-input').getValue();
									        $$('installer-form').hide();
									    	$$('installer-log').show();
							            	$$('installer-log').disable();
							            	$$('installer-back').hide();
							            	setTimeout(function() {
							            		install_sails();
							            	}, 1000);
							            } else { 
											webix.message({ type:"error", text:"Root password must not empty" });
										}
							          }
							        }
							      }
				      			 ],
				      	rules: {
				      		"installer-input":webix.rules.isNotEmpty
				      	}
			      	});
			        webix.ui({
			        	view:"button",
						css:"back-btn",
						container:"appdevgui-installer",
						width: 200,
						type: "prev",
						label: "Back",
						id: "installer-back",
						on:{
							"onItemClick": function(id, e, trg) {
							  update_page(4);
							}
						}
					});
			      </script>
			    </div>
		    </div>
    		<div class="clear"></div>
		</div>
  	</body>
</html>